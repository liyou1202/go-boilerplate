services:
  # MySQL Database
  mysql:
    profiles: ["infra"]
    image: mysql:8.0
    container_name: sd_mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root_password}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-syncdrive}
      MYSQL_USER: ${MYSQL_USER:-syncdrive_user}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-syncdrive_password}
    ports:
      - "${MYSQL_PORT:-3306}:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ../logs/mysql:/var/log/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  # MongoDB Database
  mongodb:
    profiles: ["infra"]
    image: mongo:6.0
    container_name: sd_mongodb
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USER:-admin}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD:-admin_password}
      MONGO_INITDB_DATABASE: ${MONGO_DATABASE:-syncdrive}
    ports:
      - "${MONGO_PORT:-27017}:27017"
    volumes:
      - mongodb_data:/data/db
      - ../logs/mongodb:/var/log/mongodb
    command: --logpath /var/log/mongodb/mongod.log
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis Cache
  redis:
    profiles: ["infra"]
    image: redis:7.0-alpine
    container_name: sd_redis
    restart: unless-stopped
    command: redis-server --requirepass ${REDIS_PASSWORD:-redis_password} --logfile /var/log/redis/redis.log
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
      - ../logs/redis:/var/log/redis

  # Eclipse Mosquitto MQTT Broker
  mosquitto:
    profiles: ["infra"]
    image: eclipse-mosquitto:2.0
    container_name: sd_mosquitto
    restart: unless-stopped
    ports:
      - "${MQTT_PORT:-1883}:1883"
    volumes:
      - ./mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf
      - mosquitto_data:/mosquitto/data
      - ../logs/mosquitto:/mosquitto/log

  # API Server
  api:
    profiles: ["backend"]
    build:
      context: ..
      dockerfile: deployments/Dockerfile
    container_name: sd_api
    restart: unless-stopped
    environment:
      ENV: ${ENV:-loc}
      GIN_MODE: ${GIN_MODE:-debug}
    ports:
      - "${API_PORT:-8080}:8080"
    volumes:
      - ../configs:/app/configs
      - ../logs/api:/app/logs
    depends_on:
      mysql:
        condition: service_healthy
      mongodb:
        condition: service_healthy
      mosquitto:
        condition: service_healthy

    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 3s
      retries: 3

volumes:
  mysql_data:
  mongodb_data:
  redis_data:
  mosquitto_data:
